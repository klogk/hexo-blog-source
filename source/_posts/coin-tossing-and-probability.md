---
title: 投硬币与概率分布的生成
layout: post
tags: ['public', 'post', 'probability','coin tossing', 'distribution']
time: 2014-05-20 12:00
mathjax: true
---

投硬币是组合数学和概率统计中经典的问题。最近看了不少投硬币和概率有关的问题，总结一下。

## 0-1分布

理想的硬币是无偏的0-1分布，即正面和反面的概率应该是完全相等，都等于$\dfrac{1}{2}$(不能存在恰好立起来的情况，^_^)。用信息的观点，无偏硬币其实对应了一个等概率的随机比特生成器，正面是1，背面是0。

投$k$次硬币就能够获得$P[X=1]=\dfrac{m}{2^k}$的0-1分布。例如，要让$P[X=1]=\dfrac{3}{8}$，那么就可以投掷3次，那么共有8种组合，预先约定其中的3种情况是1，其余的情况就是0。

## 二进制小数

如果$P[X=1]$不是2的幂倒数倍数呢？比如任意小数、分数，乃至无理数。

还是先再看看$P[X=1]=\dfrac{1}{8}$的情形。可以按照前面说的投3次，选一种情况作为1。

也可以换一种实验方法(几何分布)：连续投掷，直到出现正面就停，如果恰好投了3次，那么就是1，否则是0。

计算期望的投掷次数，投掷$k$次结束的概率是$\dfrac{1}{2^k}$，所以期望的投掷次数(也就是几何分布实验终止的期望次数)是：

``` latex
\sum\limits_{k=1}^{\infty} k\cdot \dfrac{1}{2^k} = 2
```

比原有的投3次的方法，有更少的期望投掷次数。从另外一个角度看，这种投掷方法，和投3次的方法比，节约了一些无用的投掷。例如，在3次投掷方法中，如果约定$[T, T, H]$是1，那么当出现$[H]$和$[T, H]$的时候就可以停止了，不用再去投掷了，因为无论如何投掷都是0。

更重要的是，这种方法可以推广到$P[X=1]$是任意的小数。对于任意的纯小数p，可以转化成二进制：

``` latex
p = 0.A_1A_2\cdots A_i\cdots , A_i\in\{0,1\}
```

那么设计这样一个实验：连续投掷直到出现正面就停止，假设投掷了$k$次，如果$p$二进制小数位的这一位$A_k=1$，那么就是发生了$1$，否则是$0$。这样的实验中，

``` latex
P[X=1] = \sum\limits_{k=1}^{\infty} A_k\cdot \dfrac{1}{2^k} = 0.A_1A_2\cdots A_i\cdots A_i = p
```

这样的期望投掷次数和$P[X=1]=\dfrac{1}{8}$的情形一样，都是$2$，和具体的概率是无关的。(如果是有限小数，在$k$超过最后一位1之后，可以直接停止，并认为是0发生了，这样的期望投掷次数还会更少。)

## $0-1$分布到离散均匀分布

有了无偏的0-1分布就能够获得一般的离散均匀分布。

最容易想到的方法是生成二进制，然后对应到所需要的区间。例如，要在随机均匀生成$[0,8)$上的随机数，那么就可以投3次硬币，那么也就是随机3个比特位，正反面分别当做1和0，恰好得到$[0,8)$对应的二进制。如果要生成$[0,2^k)$上的随机数，就可以通过投掷$k$次硬币来获得$k$位二进制。

但是如果是任意的$[0,n)$，$n$不是2的幂的时候呢？例如，现在我们有硬币，但是我们想要一个色子，如何用硬币去模拟色子呢？

一种方法是先生成$[0,2^k)$，$2^k$是大于n的最小的2的幂，需要$k$次投掷，也得到了$k$位二进制，如果这个二进制数在$[0,n)$上，那么就直接停止实验，否则就重复，再来$k$次投掷，直到落到期望的范围内。

正确性是很容易得到证明的。 一次实验就停止的概率是$p=\dfrac{n}{2^k}$，投掷1次生成某个$i\in[0,n)$的概率是$\dfrac{1}{2^k}$，投掷2次得到的概率是$\dfrac{1}{2^k}(1-p)$，加起来就得到一个等比级数

``` latex
\begin{align}
P[X=i] &= \dfrac{1}{2^k} + \dfrac{1}{2^k}(1-p) + \cdots + \dfrac{1}{2^k}(1-p)^i + \cdots \\
    &= \dfrac{1}{2^k} \cdot \dfrac{1}{p} \\
    &= \dfrac{1}{n}
\end{align}
```

也就是这个算法就得到了一个$[0,n)$上的随机数均匀生成算法。这样的生成算法期望投掷次数是

``` latex
\begin{align}
E &= k\cdot p + 2k\cdot p(1-p) + \cdots + (i+1)k\cdot p(1-p)^i + \cdots \\
  &= \dfrac{k}{p} \\
  &= \dfrac{k\cdot 2^k}{n} = \dfrac{\lceil\log n\rceil\cdot 2^{\lceil\log n\rceil}}{n} \\
E &\geq \dfrac{\lceil \log n\rceil\cdot 2^{\log n}}{n} = \lceil \log n\rceil \\
E &\leq \dfrac{\lceil \log n\rceil\cdot 2^{\log n +1}}{n} = 2\lceil \log n\rceil
\end{align}
```

这种方法其实也会有冗余的投掷，例如，$[0,5)$上的随机数生成，第一轮3次投掷生成了8个状态，其中$[H, H, H]$、$[H, H, T]$、$[H, T, H]$的状态需要进入下一轮投掷。但是其实前两次出现$[H, H]$的时候就不用再投掷第3次了，因为$[H, H, H]$、$[H, H, T]$都是要进入下一轮投掷的。

关于冗余的消除，后面再讨论。

## 二叉树模型

还是先分析对$[0,5)$上均匀分布的例子。上面的讨论得出了期望的投掷次数是
``` latex
E_5=\dfrac{k\cdot 2^k}{n}=\dfrac{3*8}{5}=4.8
```

如果去掉冗余呢？在前两次出现$[H, H]$的时候就直接进入下一轮的实验了，这里的计算就略微复杂一些。

为了方便计算，我们从另外一个角度来看待冗余的投掷, 投掷3次的结果对应了一棵高度为3的满二叉树的叶子：从树根部出发，在非叶节点上投硬币决定往左右(如图，其中二叉树非叶节点上的数值表示往左的概率)。非叶节点都对应了一次无偏硬币投掷，叶子的深度就是实验的次数。生成$[0,5)$的随机数，也就是取了5个叶子，剩下的3个叶子对应了重投的情况。

![binary tree](/img/coin-tossing-and-probability/a.svg)

上图右下角的双圆圈对应的投掷是不必要的，因为都是重投，所以可以变为

![binary tree](/img/coin-tossing-and-probability/b.svg)

为了表示重新投掷，我们可以直接把两个菱形节点的入边直接指向根。并且为了更看得清楚，我们把节点间转移的概率写到边上去

![binary tree](/img/coin-tossing-and-probability/d.svg)

于是就变成了一个带环的有向图模型了(其实就是大名鼎鼎的概率图)。平均投掷次数就是在这个有向图上终止前行走步数的期望。在这个图上，可以使用线性方程组来计算这个期望步数。完整的方程就不列了，记录$E(a)$为从$a$出发到达叶节点的期望，可以建立如下的递推关系

``` latex
E(a)=1+\sum E(b)P[a\rightarrow b]
```

算得
``` latex
E(start)=\dfrac{22}{5}=4.4
```

的确比直接生成3位二进制的方法更优了。

反过来根据二叉树得到投掷方案也是可以的。所以我们可以构造一个不需要重复实验的树，例如

![binary tree](/img/coin-tossing-and-probability/c.svg)

和之前一样，非叶节点上的数表示的是往左的概率。但每个非叶节点不必是无偏$0-1$分布了，这样的话到达所有叶节点的概率都是$\dfrac{1}{5}$。而有偏的$0-1$分布已经讨论过了，这里可以直接用到。

在这个图上标示$1/2$的非叶节点需要投1次硬币，而其它节点需要2次(期望)。于是$X=0, 1$需要投掷3次硬币，$X=2$需要4次硬币，$X=3,4$需要5次硬币，平均起来是$\dfrac{3+3+4+5+5}{5} = 4$次投掷。

树我们可以构造很多种，那么哪种树形态能够得到最少投递次数期望的概率生成方案呢。可以用动态规划算法来计算一下叶节点带权路径长度和的最小值，也就是$E_n$。

``` latex
\begin{align}
E_i &= \min_{0<j<i}\{E_j\cdot \dfrac{j}{n} + E_{i-j}\cdot \dfrac{i-j}{n} + \dfrac{i}{n}\cdot delta(j, i-j)\} \\
delta(l,r) &=
\begin{cases}
1\quad if\quad l = r \\
2\quad if\quad l \neq r
\end{cases}
\end{align}
```

算得 $E_5 = 3.6$比前几种方法更优，对应的是

![binary tree](/img/coin-tossing-and-probability/e.svg)

## 从$0-1$分布到离散非均匀分布

如果需要生成离散的非均匀分布呢？例如$\{\dfrac{1}{2},\dfrac{1}{3}, \dfrac{1}{6}\}$

事实上这个还比较特殊，可以借助于均匀分布来做，可以成生成个$[0,6)$内的均匀随机数，然后选择$3$、$2$、$1$个映射到$0$、$1$、$2$。但我们希望讨论更为一般的情况，也就是可能会有无理数，所以不考虑这种做法。

事实上根据上面的讨论，也是可以用二叉树模型的。

![binary tree](/img/coin-tossing-and-probability/f.svg)

期望的投掷次数是

``` latex
\dfrac{1}{3}\cdot 3+\dfrac{1}{6}\cdot 3+ \dfrac{1}{2}\cdot 2 = 2.5
```

对于一般的情况，不能直接使用上面的动态规划来做了。因为上面均匀分布的叶节点是无差别的，所以只和叶子数目有关，而和叶节点的顺序无关。这里状态是需要记录叶节点集合，复杂度会很高。(对小规模的情况，可以使用位压缩来记录子集)

``` latex
\begin{align}
F(S) &= \min_{\substack{S_1\cup S_2=S\\S_1\cap S_2=\Phi}}\{F(S_1)\cdot sum(S_1) + F(S_2)\cdot sum(S_2) + sum(S)*delta(S_1, S_2)\} \\
delta(S_1,S_2) &=
\begin{cases}
1\quad if\quad sum(S_1) = sum(S_2) \\
2\quad if\quad sum(S_1) \neq sum(S_2)
\end{cases}
\end{align}
```

## 有偏的硬币

上面都是如何从无偏的硬币得到均匀或者有偏的分布，如果硬币是有偏的呢？硬币以概率$p$正面朝上。

先来看如何获得无偏的$0-1$分布，可以投掷两次，如果是$[H, T]$则为$X=1$，如果是$[T, H]$则为$X=0$，其余重投。这样的正确性也是明显的，实验一次(投掷$2$次)终止的概率是$q=2p(1-p)$，发生$X=1$的概率是$p(1-p)$

``` latex
P[X=1] = p(1-p) + p(1-p)(1-q) + \cdots + p(1-p)(1-q)^i + \cdots = p(1-p)\dfrac{1}{q}=\dfrac{1}{2}
```

期望投掷的次数是

``` latex
E = 2q + 4(1-q)q + 6(1-q)^2q+\cdots+2i(1-q)^{i-1}q+\cdots=\dfrac{2}{q}=\dfrac{1}{p(1-p)}
```

作成二叉树就是下图，菱形对应了重投。

![binary tree](/img/coin-tossing-and-probability/g.svg)

也可以转换成带环的图。

有了$0-1$均匀分布就可以构造任意的离散均匀分布和非均匀分布。特别注意：这里无偏$0-1$到有偏$0-1$其实是不需要知道$p$的具体数值的。

## 从离散分布回到$0-1$分布

那能不能从离散分布出发构造其他的分布呢。

先来看，均匀分布。假设我们现在是投掷一个色子，它可以投掷一次得到一个$[1,6]$的均匀分布。

很容易想到，先由均匀分布得到一个无偏$0-1$分布：用奇数对应$1$，偶数对应$0$，这样就可以1次投掷得到一个$0-1$分布了。有了$0-1$分布，就可以再去生成其他的分布了。

假如我们有一个不一般的色子，例如7个面呢？(假设有，其实没有)。奇偶划分又有点问题了。因为奇数和偶数不是一样多的。那就引入重投吧，$[1,3]$和$[4,6]$分别是0和1，如果是$7$就重投。期望的投掷次数是$\dfrac{7}{6}$。

有了无偏$0-1$分布，按照之前的讨论，有偏$0-1$，任意离散均匀分布，任意非均匀离散分布都可以做了。

## "直线救国"

但通过无偏$0-1$分布去转化，有时会“太浪费”了。例如，要获得$[0,5)$的均匀分布，由前面的讨论可以由$3.6$次无偏硬币投掷得到，而一次6面色子的投掷可以对应一次硬币投掷。但事实上投一次6面色子是可以区分6种状态，这种通过$0-1$分布曲线救国的方法只利用了一半。

受前面“重投”的思想启发，可以用色子结果的$[1,4]$来对应$[0,5)$，如果是6，那么就重投。这样的期望投掷次数是$\dfrac{6}{5}$。

如果目标均匀分布的范围大于$6$呢？ 前面二进制的思想又启发我们用六进制来做。

例如做一个$[0,8)$上的均匀分布，投两次，相当于2位六进制，共有36种，各选取4种对应作为$[0,8)$，然后剩下的4种再进行重投。分析方法和二进制时候类似，$m$进制下实现$[0,n)$的期望投掷次数是$\dfrac{k\cdot m^k}{n}$，$k$是满足$m^k\geq n$的最小值。

当然这样也是会有冗余的，类似前面二进制的时候，不必投到每一位六进制都出现。也可以画六叉树来做分析。这里就不画图了。

之前我们用有偏$0-1$分布来得到一般均匀分布更少实验次数的生成方法，这里能不能使用呢？先来看看有偏$0-1$分布的生成。

有偏$0-1$分布如果通过均匀分布到无偏$0-1$分布来转，当均匀分布的个数是偶数的时候，期望投掷次数会是$2$，和无偏$0-1$分布相同；如果是奇数，那么会是$\dfrac{2n}{n-1}$。

## n进制小数

能否再更优呢？答案是可以的。在这里直接给出方法，然后再分析。 假设用$[0,n)$的均匀分布生成$P[X=1]=p$的有偏$0-1$分布。把$p$用$n$进制来表示

``` latex
p = 0.A_1A_2\cdots A_i\cdots, A_i\in[0, n)
```

重复$[0,n)$的均匀分布实验，满足这样一个条件的时候就停止：第$k$次的结果是$m$，如果$A_k\neq m$。如果停止时$m<A_k$则认为发生了$1$，如果$m>A_k$则发生了$0$。

(如果是有限小数，在到了最后一个非0位之后，可以直接停止，并认为是0，因为不再会出现$m<A_k$)

这个前面二进制小数分解，得到有偏$0-1$分布的做法类似，但有细微差别。

正确性也很好证明。在第$k$次实验停止并为1的概率是$\dfrac{A_k}{n^k}$，求和就是

``` latex
\sum\limits_{k=1}^{\infty} \dfrac{A_k}{n^k}=0.A_1A_2\cdots A_k\cdots=p
```

实验到第$k$次停止的概率是$\dfrac{n-1}{n^k}$，于是期望的重复实验次数是

``` latex
\sum\limits_{k=1}^{\infty}k\cdot \dfrac{n-1}{n^k} = \dfrac{n}{n-1}
```

有了有偏$0-1$分布之后，也就能够再改进生成均匀分布的方法了。

来简单看一个规模更小的例子上这种方法的威力：

1. 用$[0,3)$的均匀分布生成$[0,5)$的均匀分布，用3进制的方法是期望实验$3.6$次。
2. 用有偏的方法，先生成一个$P[X=1]=\dfrac{3}{5}$的$0-1$分布，期望$1.5$次；如果$X=1$那么再做一次$[0,3)$均匀分布，得到$[0,3)$；如果$X=2$那么再做一次无偏的$0-1$分布，对应到$[3,5)$。这样期望的次数是$\dfrac{2.5\cdot 3+3\cdot 2}{5}= 2.7$次。

显然更优。

从多叉树模型来看，优化的策略是：尽量让$[0,3)$分布在上层，否则使用$[0,3)$先做一个$0-1$分布。

推广到从任意的$[0,n)$均匀分布生成$[0,m)$均匀分布，也可以使用动态规划算法来做。递推方程和前面类似，注意$[0,kn)$是可以直接一次实验生成$[0,n)$的，即约数都可以直接生成。

有了高效的任意$0-1$分布生成方法，也就可以继续做非均匀的任意离散分布。。

## 结束语

无偏的硬币(无偏$0-1$分布)、有偏的硬币(有偏$0-1$分布)、无偏的色子(离散均匀分布)、有偏的色子(离散分布均匀分布)就可以通过适当的重负投掷实现相互转化。二叉树和多叉树的模型帮助分析概率的变化非常有用。

遗留问题:

2. 有偏$0-1$到均匀分布是否可以不经过无偏$0-1$的转换而更优？
1. 因为上面的有偏$0-1$到无偏$0-1$并不依赖于有偏$0-1$的具体概率分布，能否在某些条件下做到更优？
1. 上面的这些方法是不是最优？

